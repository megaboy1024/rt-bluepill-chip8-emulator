/*
 * Copyright (c) 2006-2018, RT-Thread Development Team
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 * Change Logs:
 * Date           Author       Notes
 * 2019-03-08     obito0       first version
 */

#include <rtthread.h>
#include <rtdevice.h>
#include <board.h>
#include <ssd1306.h>
#include <inttypes.h>
#include <chip8.h>


#define KEY_C4_PIN    GET_PIN(B, 15)
#define KEY_C3_PIN    GET_PIN(B, 14)
#define KEY_C2_PIN    GET_PIN(B, 13)
#define KEY_C1_PIN    GET_PIN(B, 12)
#define KEY_R4_PIN    GET_PIN(B, 5)
#define KEY_R3_PIN    GET_PIN(B, 4)
#define KEY_R2_PIN    GET_PIN(B, 3)
#define KEY_R1_PIN    GET_PIN(A, 15)

// 4x4 keypad array
uint8_t const pinRow[] = { KEY_R1_PIN, KEY_R2_PIN, KEY_R3_PIN, KEY_R4_PIN };
uint8_t const pinCol[] = { KEY_C1_PIN, KEY_C2_PIN, KEY_C3_PIN, KEY_C4_PIN };

// array size is 478
static const unsigned char test_opcode[]  = {
  0x12, 0x4e, 0xea, 0xac, 0xaa, 0xea, 0xce, 0xaa, 0xaa, 0xae, 0xe0, 0xa0, 0xa0, 0xe0, 0xc0, 0x40,
  0x40, 0xe0, 0xe0, 0x20, 0xc0, 0xe0, 0xe0, 0x60, 0x20, 0xe0, 0xa0, 0xe0, 0x20, 0x20, 0x60, 0x40,
  0x20, 0x40, 0xe0, 0x80, 0xe0, 0xe0, 0xe0, 0x20, 0x20, 0x20, 0xe0, 0xe0, 0xa0, 0xe0, 0xe0, 0xe0,
  0x20, 0xe0, 0x40, 0xa0, 0xe0, 0xa0, 0xe0, 0xc0, 0x80, 0xe0, 0xe0, 0x80, 0xc0, 0x80, 0xa0, 0x40,
  0xa0, 0xa0, 0xa2, 0x02, 0xda, 0xb4, 0x00, 0xee, 0xa2, 0x02, 0xda, 0xb4, 0x13, 0xdc, 0x68, 0x01,
  0x69, 0x05, 0x6a, 0x0a, 0x6b, 0x01, 0x65, 0x2a, 0x66, 0x2b, 0xa2, 0x16, 0xd8, 0xb4, 0xa2, 0x3e,
  0xd9, 0xb4, 0xa2, 0x02, 0x36, 0x2b, 0xa2, 0x06, 0xda, 0xb4, 0x6b, 0x06, 0xa2, 0x1a, 0xd8, 0xb4,
  0xa2, 0x3e, 0xd9, 0xb4, 0xa2, 0x06, 0x45, 0x2a, 0xa2, 0x02, 0xda, 0xb4, 0x6b, 0x0b, 0xa2, 0x1e,
  0xd8, 0xb4, 0xa2, 0x3e, 0xd9, 0xb4, 0xa2, 0x06, 0x55, 0x60, 0xa2, 0x02, 0xda, 0xb4, 0x6b, 0x10,
  0xa2, 0x26, 0xd8, 0xb4, 0xa2, 0x3e, 0xd9, 0xb4, 0xa2, 0x06, 0x76, 0xff, 0x46, 0x2a, 0xa2, 0x02,
  0xda, 0xb4, 0x6b, 0x15, 0xa2, 0x2e, 0xd8, 0xb4, 0xa2, 0x3e, 0xd9, 0xb4, 0xa2, 0x06, 0x95, 0x60,
  0xa2, 0x02, 0xda, 0xb4, 0x6b, 0x1a, 0xa2, 0x32, 0xd8, 0xb4, 0xa2, 0x3e, 0xd9, 0xb4, 0x22, 0x42,
  0x68, 0x17, 0x69, 0x1b, 0x6a, 0x20, 0x6b, 0x01, 0xa2, 0x0a, 0xd8, 0xb4, 0xa2, 0x36, 0xd9, 0xb4,
  0xa2, 0x02, 0xda, 0xb4, 0x6b, 0x06, 0xa2, 0x2a, 0xd8, 0xb4, 0xa2, 0x0a, 0xd9, 0xb4, 0xa2, 0x06,
  0x87, 0x50, 0x47, 0x2a, 0xa2, 0x02, 0xda, 0xb4, 0x6b, 0x0b, 0xa2, 0x2a, 0xd8, 0xb4, 0xa2, 0x0e,
  0xd9, 0xb4, 0xa2, 0x06, 0x67, 0x2a, 0x87, 0xb1, 0x47, 0x2b, 0xa2, 0x02, 0xda, 0xb4, 0x6b, 0x10,
  0xa2, 0x2a, 0xd8, 0xb4, 0xa2, 0x12, 0xd9, 0xb4, 0xa2, 0x06, 0x66, 0x78, 0x67, 0x1f, 0x87, 0x62,
  0x47, 0x18, 0xa2, 0x02, 0xda, 0xb4, 0x6b, 0x15, 0xa2, 0x2a, 0xd8, 0xb4, 0xa2, 0x16, 0xd9, 0xb4,
  0xa2, 0x06, 0x66, 0x78, 0x67, 0x1f, 0x87, 0x63, 0x47, 0x67, 0xa2, 0x02, 0xda, 0xb4, 0x6b, 0x1a,
  0xa2, 0x2a, 0xd8, 0xb4, 0xa2, 0x1a, 0xd9, 0xb4, 0xa2, 0x06, 0x66, 0x8c, 0x67, 0x8c, 0x87, 0x64,
  0x47, 0x18, 0xa2, 0x02, 0xda, 0xb4, 0x68, 0x2c, 0x69, 0x30, 0x6a, 0x34, 0x6b, 0x01, 0xa2, 0x2a,
  0xd8, 0xb4, 0xa2, 0x1e, 0xd9, 0xb4, 0xa2, 0x06, 0x66, 0x8c, 0x67, 0x78, 0x87, 0x65, 0x47, 0xec,
  0xa2, 0x02, 0xda, 0xb4, 0x6b, 0x06, 0xa2, 0x2a, 0xd8, 0xb4, 0xa2, 0x22, 0xd9, 0xb4, 0xa2, 0x06,
  0x66, 0xe0, 0x86, 0x6e, 0x46, 0xc0, 0xa2, 0x02, 0xda, 0xb4, 0x6b, 0x0b, 0xa2, 0x2a, 0xd8, 0xb4,
  0xa2, 0x36, 0xd9, 0xb4, 0xa2, 0x06, 0x66, 0x0f, 0x86, 0x66, 0x46, 0x07, 0xa2, 0x02, 0xda, 0xb4,
  0x6b, 0x10, 0xa2, 0x3a, 0xd8, 0xb4, 0xa2, 0x1e, 0xd9, 0xb4, 0xa3, 0xe8, 0x60, 0x00, 0x61, 0x30,
  0xf1, 0x55, 0xa3, 0xe9, 0xf0, 0x65, 0xa2, 0x06, 0x40, 0x30, 0xa2, 0x02, 0xda, 0xb4, 0x6b, 0x15,
  0xa2, 0x3a, 0xd8, 0xb4, 0xa2, 0x16, 0xd9, 0xb4, 0xa3, 0xe8, 0x66, 0x89, 0xf6, 0x33, 0xf2, 0x65,
  0xa2, 0x02, 0x30, 0x01, 0xa2, 0x06, 0x31, 0x03, 0xa2, 0x06, 0x32, 0x07, 0xa2, 0x06, 0xda, 0xb4,
  0x6b, 0x1a, 0xa2, 0x0e, 0xd8, 0xb4, 0xa2, 0x3e, 0xd9, 0xb4, 0x12, 0x48, 0x13, 0xdc
};

static const unsigned char Space_Invaders[] = { 0x12, 0x25, 0x53, 0x50, 0x41, 0x43, 0x45, 0x20, 0x49, 0x4E, 0x56, 0x41,
        0x44, 0x45, 0x52, 0x53, 0x20, 0x76, 0x30, 0x2E, 0x39, 0x20, 0x42, 0x79, 0x20, 0x44, 0x61, 0x76, 0x69, 0x64,
        0x20, 0x57, 0x49, 0x4E, 0x54, 0x45, 0x52, 0x60, 0x00, 0x61, 0x00, 0x62, 0x08, 0xA3, 0xD3, 0xD0, 0x18, 0x71,
        0x08, 0xF2, 0x1E, 0x31, 0x20, 0x12, 0x2D, 0x70, 0x08, 0x61, 0x00, 0x30, 0x40, 0x12, 0x2D, 0x69, 0x05, 0x6C,
        0x15, 0x6E, 0x00, 0x23, 0x87, 0x60, 0x0A, 0xF0, 0x15, 0xF0, 0x07, 0x30, 0x00, 0x12, 0x4B, 0x23, 0x87, 0x7E,
        0x01, 0x12, 0x45, 0x66, 0x00, 0x68, 0x1C, 0x69, 0x00, 0x6A, 0x04, 0x6B, 0x0A, 0x6C, 0x04, 0x6D, 0x3C, 0x6E,
        0x0F, 0x00, 0xE0, 0x23, 0x6B, 0x23, 0x47, 0xFD, 0x15, 0x60, 0x04, 0xE0, 0x9E, 0x12, 0x7D, 0x23, 0x6B, 0x38,
        0x00, 0x78, 0xFF, 0x23, 0x6B, 0x60, 0x06, 0xE0, 0x9E, 0x12, 0x8B, 0x23, 0x6B, 0x38, 0x39, 0x78, 0x01, 0x23,
        0x6B, 0x36, 0x00, 0x12, 0x9F, 0x60, 0x05, 0xE0, 0x9E, 0x12, 0xE9, 0x66, 0x01, 0x65, 0x1B, 0x84, 0x80, 0xA3,
        0xCF, 0xD4, 0x51, 0xA3, 0xCF, 0xD4, 0x51, 0x75, 0xFF, 0x35, 0xFF, 0x12, 0xAD, 0x66, 0x00, 0x12, 0xE9, 0xD4,
        0x51, 0x3F, 0x01, 0x12, 0xE9, 0xD4, 0x51, 0x66, 0x00, 0x83, 0x40, 0x73, 0x03, 0x83, 0xB5, 0x62, 0xF8, 0x83,
        0x22, 0x62, 0x08, 0x33, 0x00, 0x12, 0xC9, 0x23, 0x73, 0x82, 0x06, 0x43, 0x08, 0x12, 0xD3, 0x33, 0x10, 0x12,
        0xD5, 0x23, 0x73, 0x82, 0x06, 0x33, 0x18, 0x12, 0xDD, 0x23, 0x73, 0x82, 0x06, 0x43, 0x20, 0x12, 0xE7, 0x33,
        0x28, 0x12, 0xE9, 0x23, 0x73, 0x3E, 0x00, 0x13, 0x07, 0x79, 0x06, 0x49, 0x18, 0x69, 0x00, 0x6A, 0x04, 0x6B,
        0x0A, 0x6C, 0x04, 0x7D, 0xF4, 0x6E, 0x0F, 0x00, 0xE0, 0x23, 0x47, 0x23, 0x6B, 0xFD, 0x15, 0x12, 0x6F, 0xF7,
        0x07, 0x37, 0x00, 0x12, 0x6F, 0xFD, 0x15, 0x23, 0x47, 0x8B, 0xA4, 0x3B, 0x12, 0x13, 0x1B, 0x7C, 0x02, 0x6A,
        0xFC, 0x3B, 0x02, 0x13, 0x23, 0x7C, 0x02, 0x6A, 0x04, 0x23, 0x47, 0x3C, 0x18, 0x12, 0x6F, 0x00, 0xE0, 0xA4,
        0xD3, 0x60, 0x14, 0x61, 0x08, 0x62, 0x0F, 0xD0, 0x1F, 0x70, 0x08, 0xF2, 0x1E, 0x30, 0x2C, 0x13, 0x33, 0xF0,
        0x0A, 0x00, 0xE0, 0xA6, 0xF4, 0xFE, 0x65, 0x12, 0x25, 0xA3, 0xB7, 0xF9, 0x1E, 0x61, 0x08, 0x23, 0x5F, 0x81,
        0x06, 0x23, 0x5F, 0x81, 0x06, 0x23, 0x5F, 0x81, 0x06, 0x23, 0x5F, 0x7B, 0xD0, 0x00, 0xEE, 0x80, 0xE0, 0x80,
        0x12, 0x30, 0x00, 0xDB, 0xC6, 0x7B, 0x0C, 0x00, 0xEE, 0xA3, 0xCF, 0x60, 0x1C, 0xD8, 0x04, 0x00, 0xEE, 0x23,
        0x47, 0x8E, 0x23, 0x23, 0x47, 0x60, 0x05, 0xF0, 0x18, 0xF0, 0x15, 0xF0, 0x07, 0x30, 0x00, 0x13, 0x7F, 0x00,
        0xEE, 0x6A, 0x00, 0x8D, 0xE0, 0x6B, 0x04, 0xE9, 0xA1, 0x12, 0x57, 0xA6, 0x02, 0xFD, 0x1E, 0xF0, 0x65, 0x30,
        0xFF, 0x13, 0xA5, 0x6A, 0x00, 0x6B, 0x04, 0x6D, 0x01, 0x6E, 0x01, 0x13, 0x8D, 0xA5, 0x00, 0xF0, 0x1E, 0xDB,
        0xC6, 0x7B, 0x08, 0x7D, 0x01, 0x7A, 0x01, 0x3A, 0x07, 0x13, 0x8D, 0x00, 0xEE, 0x3C, 0x7E, 0xFF, 0xFF, 0x99,
        0x99, 0x7E, 0xFF, 0xFF, 0x24, 0x24, 0xE7, 0x7E, 0xFF, 0x3C, 0x3C, 0x7E, 0xDB, 0x81, 0x42, 0x3C, 0x7E, 0xFF,
        0xDB, 0x10, 0x38, 0x7C, 0xFE, 0x00, 0x00, 0x7F, 0x00, 0x3F, 0x00, 0x7F, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01,
        0x03, 0x03, 0x03, 0x03, 0x00, 0x00, 0x3F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x3F, 0x08, 0x08,
        0xFF, 0x00, 0x00, 0xFE, 0x00, 0xFC, 0x00, 0xFE, 0x00, 0x00, 0x00, 0x7E, 0x42, 0x42, 0x62, 0x62, 0x62, 0x62,
        0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x7D, 0x00,
        0x41, 0x7D, 0x05, 0x7D, 0x7D, 0x00, 0x00, 0xC2, 0xC2, 0xC6, 0x44, 0x6C, 0x28, 0x38, 0x00, 0x00, 0xFF, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0xF7, 0x10, 0x14, 0xF7, 0xF7, 0x04,
        0x04, 0x00, 0x00, 0x7C, 0x44, 0xFE, 0xC2, 0xC2, 0xC2, 0xC2, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0xEF, 0x20, 0x28, 0xE8, 0xE8, 0x2F, 0x2F, 0x00, 0x00, 0xF9,
        0x85, 0xC5, 0xC5, 0xC5, 0xC5, 0xF9, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF,
        0x00, 0x00, 0xFF, 0x00, 0xBE, 0x00, 0x20, 0x30, 0x20, 0xBE, 0xBE, 0x00, 0x00, 0xF7, 0x04, 0xE7, 0x85, 0x85,
        0x84, 0xF4, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00,
        0x00, 0x7F, 0x00, 0x3F, 0x00, 0x7F, 0x00, 0x00, 0x00, 0xEF, 0x28, 0xEF, 0x00, 0xE0, 0x60, 0x6F, 0x00, 0x00,
        0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFE, 0x00, 0xFC,
        0x00, 0xFE, 0x00, 0x00, 0x00, 0xC0, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0xFC, 0x04, 0x04, 0x04,
        0x04, 0x04, 0x04, 0x04, 0x04, 0xFC, 0x10, 0x10, 0xFF, 0xF9, 0x81, 0xB9, 0x8B, 0x9A, 0x9A, 0xFA, 0x00, 0xFA,
        0x8A, 0x9A, 0x9A, 0x9B, 0x99, 0xF8, 0xE6, 0x25, 0x25, 0xF4, 0x34, 0x34, 0x34, 0x00, 0x17, 0x14, 0x34, 0x37,
        0x36, 0x26, 0xC7, 0xDF, 0x50, 0x50, 0x5C, 0xD8, 0xD8, 0xDF, 0x00, 0xDF, 0x11, 0x1F, 0x12, 0x1B, 0x19, 0xD9,
        0x7C, 0x44, 0xFE, 0x86, 0x86, 0x86, 0xFC, 0x84, 0xFE, 0x82, 0x82, 0xFE, 0xFE, 0x80, 0xC0, 0xC0, 0xC0, 0xFE,
        0xFC, 0x82, 0xC2, 0xC2, 0xC2, 0xFC, 0xFE, 0x80, 0xF8, 0xC0, 0xC0, 0xFE, 0xFE, 0x80, 0xF0, 0xC0, 0xC0, 0xC0,
        0xFE, 0x80, 0xBE, 0x86, 0x86, 0xFE, 0x86, 0x86, 0xFE, 0x86, 0x86, 0x86, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
        0x18, 0x18, 0x18, 0x48, 0x48, 0x78, 0x9C, 0x90, 0xB0, 0xC0, 0xB0, 0x9C, 0x80, 0x80, 0xC0, 0xC0, 0xC0, 0xFE,
        0xEE, 0x92, 0x92, 0x86, 0x86, 0x86, 0xFE, 0x82, 0x86, 0x86, 0x86, 0x86, 0x7C, 0x82, 0x86, 0x86, 0x86, 0x7C,
        0xFE, 0x82, 0xFE, 0xC0, 0xC0, 0xC0, 0x7C, 0x82, 0xC2, 0xCA, 0xC4, 0x7A, 0xFE, 0x86, 0xFE, 0x90, 0x9C, 0x84,
        0xFE, 0xC0, 0xFE, 0x02, 0x02, 0xFE, 0xFE, 0x10, 0x30, 0x30, 0x30, 0x30, 0x82, 0x82, 0xC2, 0xC2, 0xC2, 0xFE,
        0x82, 0x82, 0x82, 0xEE, 0x38, 0x10, 0x86, 0x86, 0x96, 0x92, 0x92, 0xEE, 0x82, 0x44, 0x38, 0x38, 0x44, 0x82,
        0x82, 0x82, 0xFE, 0x30, 0x30, 0x30, 0xFE, 0x02, 0x1E, 0xF0, 0x80, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x06, 0x06,
        0x00, 0x00, 0x00, 0x60, 0x60, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18,
        0x7C, 0xC6, 0x0C, 0x18, 0x00, 0x18, 0x00, 0x00, 0xFE, 0xFE, 0x00, 0x00, 0xFE, 0x82, 0x86, 0x86, 0x86, 0xFE,
        0x08, 0x08, 0x08, 0x18, 0x18, 0x18, 0xFE, 0x02, 0xFE, 0xC0, 0xC0, 0xFE, 0xFE, 0x02, 0x1E, 0x06, 0x06, 0xFE,
        0x84, 0xC4, 0xC4, 0xFE, 0x04, 0x04, 0xFE, 0x80, 0xFE, 0x06, 0x06, 0xFE, 0xC0, 0xC0, 0xC0, 0xFE, 0x82, 0xFE,
        0xFE, 0x02, 0x02, 0x06, 0x06, 0x06, 0x7C, 0x44, 0xFE, 0x86, 0x86, 0xFE, 0xFE, 0x82, 0xFE, 0x06, 0x06, 0x06,
        0x44, 0xFE, 0x44, 0x44, 0xFE, 0x44, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0x6C, 0x5A, 0x00, 0x0C, 0x18,
        0xA8, 0x30, 0x4E, 0x7E, 0x00, 0x12, 0x18, 0x66, 0x6C, 0xA8, 0x5A, 0x66, 0x54, 0x24, 0x66, 0x00, 0x48, 0x48,
        0x18, 0x12, 0xA8, 0x06, 0x90, 0xA8, 0x12, 0x00, 0x7E, 0x30, 0x12, 0xA8, 0x84, 0x30, 0x4E, 0x72, 0x18, 0x66,
        0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0x90, 0x54, 0x78, 0xA8, 0x48, 0x78, 0x6C, 0x72, 0xA8, 0x12, 0x18, 0x6C,
        0x72, 0x66, 0x54, 0x90, 0xA8, 0x72, 0x2A, 0x18, 0xA8, 0x30, 0x4E, 0x7E, 0x00, 0x12, 0x18, 0x66, 0x6C, 0xA8,
        0x72, 0x54, 0xA8, 0x5A, 0x66, 0x18, 0x7E, 0x18, 0x4E, 0x72, 0xA8, 0x72, 0x2A, 0x18, 0x30, 0x66, 0xA8, 0x30,
        0x4E, 0x7E, 0x00, 0x6C, 0x30, 0x54, 0x4E, 0x9C, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0x48, 0x54, 0x7E,
        0x18, 0xA8, 0x90, 0x54, 0x78, 0x66, 0xA8, 0x6C, 0x2A, 0x30, 0x5A, 0xA8, 0x84, 0x30, 0x72, 0x2A, 0xA8, 0xD8,
        0xA8, 0x00, 0x4E, 0x12, 0xA8, 0xE4, 0xA2, 0xA8, 0x00, 0x4E, 0x12, 0xA8, 0x6C, 0x2A, 0x54, 0x54, 0x72, 0xA8,
        0x84, 0x30, 0x72, 0x2A, 0xA8, 0xDE, 0x9C, 0xA8, 0x72, 0x2A, 0x18, 0xA8, 0x0C, 0x54, 0x48, 0x5A, 0x78, 0x72,
        0x18, 0x66, 0xA8, 0x72, 0x18, 0x42, 0x42, 0x6C, 0xA8, 0x72, 0x2A, 0x00, 0x72, 0xA8, 0x72, 0x2A, 0x18, 0xA8,
        0x30, 0x4E, 0x7E, 0x00, 0x12, 0x18, 0x66, 0x6C, 0xA8, 0x30, 0x4E, 0x0C, 0x66, 0x18, 0x00, 0x6C, 0x18, 0xA8,
        0x72, 0x2A, 0x18, 0x30, 0x66, 0xA8, 0x1E, 0x54, 0x66, 0x0C, 0x18, 0x9C, 0xA8, 0x24, 0x54, 0x54, 0x12, 0xA8,
        0x42, 0x78, 0x0C, 0x3C, 0xA8, 0xAE, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xFF, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

// array size is 494
static const unsigned char Tetris_Fran_Dachille_1991_[] = { 0xa2, 0xb4, 0x23, 0xe6, 0x22, 0xb6, 0x70, 0x01, 0xd0, 0x11,
        0x30, 0x25, 0x12, 0x06, 0x71, 0xff, 0xd0, 0x11, 0x60, 0x1a, 0xd0, 0x11, 0x60, 0x25, 0x31, 0x00, 0x12, 0x0e,
        0xc4, 0x70, 0x44, 0x70, 0x12, 0x1c, 0xc3, 0x03, 0x60, 0x1e, 0x61, 0x03, 0x22, 0x5c, 0xf5, 0x15, 0xd0, 0x14,
        0x3f, 0x01, 0x12, 0x3c, 0xd0, 0x14, 0x71, 0xff, 0xd0, 0x14, 0x23, 0x40, 0x12, 0x1c, 0xe7, 0xa1, 0x22, 0x72,
        0xe8, 0xa1, 0x22, 0x84, 0xe9, 0xa1, 0x22, 0x96, 0xe2, 0x9e, 0x12, 0x50, 0x66, 0x00, 0xf6, 0x15, 0xf6, 0x07,
        0x36, 0x00, 0x12, 0x3c, 0xd0, 0x14, 0x71, 0x01, 0x12, 0x2a, 0xa2, 0xc4, 0xf4, 0x1e, 0x66, 0x00, 0x43, 0x01,
        0x66, 0x04, 0x43, 0x02, 0x66, 0x08, 0x43, 0x03, 0x66, 0x0c, 0xf6, 0x1e, 0x00, 0xee, 0xd0, 0x14, 0x70, 0xff,
        0x23, 0x34, 0x3f, 0x01, 0x00, 0xee, 0xd0, 0x14, 0x70, 0x01, 0x23, 0x34, 0x00, 0xee, 0xd0, 0x14, 0x70, 0x01,
        0x23, 0x34, 0x3f, 0x01, 0x00, 0xee, 0xd0, 0x14, 0x70, 0xff, 0x23, 0x34, 0x00, 0xee, 0xd0, 0x14, 0x73, 0x01,
        0x43, 0x04, 0x63, 0x00, 0x22, 0x5c, 0x23, 0x34, 0x3f, 0x01, 0x00, 0xee, 0xd0, 0x14, 0x73, 0xff, 0x43, 0xff,
        0x63, 0x03, 0x22, 0x5c, 0x23, 0x34, 0x00, 0xee, 0x80, 0x00, 0x67, 0x05, 0x68, 0x06, 0x69, 0x04, 0x61, 0x1f,
        0x65, 0x10, 0x62, 0x07, 0x00, 0xee, 0x40, 0xe0, 0x00, 0x00, 0x40, 0xc0, 0x40, 0x00, 0x00, 0xe0, 0x40, 0x00,
        0x40, 0x60, 0x40, 0x00, 0x40, 0x40, 0x60, 0x00, 0x20, 0xe0, 0x00, 0x00, 0xc0, 0x40, 0x40, 0x00, 0x00, 0xe0,
        0x80, 0x00, 0x40, 0x40, 0xc0, 0x00, 0x00, 0xe0, 0x20, 0x00, 0x60, 0x40, 0x40, 0x00, 0x80, 0xe0, 0x00, 0x00,
        0x40, 0xc0, 0x80, 0x00, 0xc0, 0x60, 0x00, 0x00, 0x40, 0xc0, 0x80, 0x00, 0xc0, 0x60, 0x00, 0x00, 0x80, 0xc0,
        0x40, 0x00, 0x00, 0x60, 0xc0, 0x00, 0x80, 0xc0, 0x40, 0x00, 0x00, 0x60, 0xc0, 0x00, 0xc0, 0xc0, 0x00, 0x00,
        0xc0, 0xc0, 0x00, 0x00, 0xc0, 0xc0, 0x00, 0x00, 0xc0, 0xc0, 0x00, 0x00, 0x40, 0x40, 0x40, 0x40, 0x00, 0xf0,
        0x00, 0x00, 0x40, 0x40, 0x40, 0x40, 0x00, 0xf0, 0x00, 0x00, 0xd0, 0x14, 0x66, 0x35, 0x76, 0xff, 0x36, 0x00,
        0x13, 0x38, 0x00, 0xee, 0xa2, 0xb4, 0x8c, 0x10, 0x3c, 0x1e, 0x7c, 0x01, 0x3c, 0x1e, 0x7c, 0x01, 0x3c, 0x1e,
        0x7c, 0x01, 0x23, 0x5e, 0x4b, 0x0a, 0x23, 0x72, 0x91, 0xc0, 0x00, 0xee, 0x71, 0x01, 0x13, 0x50, 0x60, 0x1b,
        0x6b, 0x00, 0xd0, 0x11, 0x3f, 0x00, 0x7b, 0x01, 0xd0, 0x11, 0x70, 0x01, 0x30, 0x25, 0x13, 0x62, 0x00, 0xee,
        0x60, 0x1b, 0xd0, 0x11, 0x70, 0x01, 0x30, 0x25, 0x13, 0x74, 0x8e, 0x10, 0x8d, 0xe0, 0x7e, 0xff, 0x60, 0x1b,
        0x6b, 0x00, 0xd0, 0xe1, 0x3f, 0x00, 0x13, 0x90, 0xd0, 0xe1, 0x13, 0x94, 0xd0, 0xd1, 0x7b, 0x01, 0x70, 0x01,
        0x30, 0x25, 0x13, 0x86, 0x4b, 0x00, 0x13, 0xa6, 0x7d, 0xff, 0x7e, 0xff, 0x3d, 0x01, 0x13, 0x82, 0x23, 0xc0,
        0x3f, 0x01, 0x23, 0xc0, 0x7a, 0x01, 0x23, 0xc0, 0x80, 0xa0, 0x6d, 0x07, 0x80, 0xd2, 0x40, 0x04, 0x75, 0xfe,
        0x45, 0x02, 0x65, 0x04, 0x00, 0xee, 0xa7, 0x00, 0xf2, 0x55, 0xa8, 0x04, 0xfa, 0x33, 0xf2, 0x65, 0xf0, 0x29,
        0x6d, 0x32, 0x6e, 0x00, 0xdd, 0xe5, 0x7d, 0x05, 0xf1, 0x29, 0xdd, 0xe5, 0x7d, 0x05, 0xf2, 0x29, 0xdd, 0xe5,
        0xa7, 0x00, 0xf2, 0x65, 0xa2, 0xb4, 0x00, 0xee, 0x6a, 0x00, 0x60, 0x19, 0x00, 0xee, 0x37, 0x23 };

/* defined the LED0 pin: PC13 */
#define LED0_PIN    GET_PIN(C, 13)
#define SDA_PIN    GET_PIN(B, 7)
#define SCL_PIN    GET_PIN(B, 6)

#define SPEAKER_PIN GET_PIN(A, 0)

int pixdbl = 0;
uint8_t x, y;

#define  PIXEL_ON White
#define  PIXEL_OFF Black

void putpixel(int x, int y, int p)
{
    if (pixdbl)
    {
        x <<= 1;
        y <<= 1;
        ssd1306_DrawPixel(x, y, p & 1);
        ssd1306_DrawPixel(x + 1, y, p & 1);
        ssd1306_DrawPixel(x, y + 1, p & 1);
        ssd1306_DrawPixel(x + 1, y + 1, p & 1);
    }
    else
        ssd1306_DrawPixel(x, y, p & 1);
}

enum Button
{
    UP = 0, RIGHT, DOWN, LEFT, B1, B2, B3, B4, B5, B6
};

void draw_Intro(void)
{
    ssd1306_Init();
//    ssd1306_Fill(Black);
//    ssd1306_UpdateScreen();
    ssd1306_Fill(Black);
    ssd1306_SetCursor(2, 0);
    ssd1306_WriteString(" CHIP8 ", Font_16x26, White);
    ssd1306_SetCursor(2, 26);
    ssd1306_WriteString("  Emulator ", Font_11x18, White);
    ssd1306_SetCursor(2, 26 + 18);
    ssd1306_WriteString(" Using RT-Thread", Font_7x10, White);
    ssd1306_SetCursor(2, 26 + 18 + 10);
    ssd1306_WriteString("     IoT System", Font_6x8, White);
    ssd1306_UpdateScreen();
}
#ifdef FINSH_USING_MSH
MSH_CMD_EXPORT(draw_Intro, draw Intro on oled display);
#endif

//void print_rom(unsigned char * rom, size_t len)
void print_rom(void)
{
    for (int i = 0; i < sizeof(Tetris_Fran_Dachille_1991_) / sizeof(Tetris_Fran_Dachille_1991_[0]); ++i)
    {
        rt_kprintf("0x%X ", Tetris_Fran_Dachille_1991_[i]);
        if ((i % 16) == 0)
            rt_kprintf("\n");
    }
    rt_kprintf("\n");
}
#ifdef FINSH_USING_MSH
MSH_CMD_EXPORT(print_rom, print rom content);
#endif

int key_init(void)
{
    /* set Key Rows pins as PP outputs*/
    rt_pin_mode(KEY_R1_PIN, PIN_MODE_OUTPUT);
    rt_pin_mode(KEY_R2_PIN, PIN_MODE_OUTPUT);
    rt_pin_mode(KEY_R3_PIN, PIN_MODE_OUTPUT);
    rt_pin_mode(KEY_R4_PIN, PIN_MODE_OUTPUT);

    /* set Key Columns pins as PD inputs*/
    rt_pin_mode(KEY_C1_PIN, PIN_MODE_INPUT_PULLDOWN);
    rt_pin_mode(KEY_C2_PIN, PIN_MODE_INPUT_PULLDOWN);
    rt_pin_mode(KEY_C3_PIN, PIN_MODE_INPUT_PULLDOWN);
    rt_pin_mode(KEY_C4_PIN, PIN_MODE_INPUT_PULLDOWN);

    return RT_EOK;
}

uint32_t key_read(void)
{
    uint32_t ret = 0;
    uint32_t row = 0;
    uint32_t col = 0;
    uint32_t i = 0;

    for (row = 0; row < sizeof(pinRow) / sizeof(pinRow[0]); row++)
    {

        for (i = 0; i < sizeof(pinRow) / sizeof(pinRow[0]); i++)
        {

            rt_pin_write(pinRow[i], PIN_LOW);
        }
        rt_pin_write(pinRow[row], PIN_HIGH);

        for (col = 0; col < sizeof(pinCol) / sizeof(pinCol[0]); col++)
        {
            ret <<= 1;
            ret |= rt_pin_read(pinCol[col]);
        }
    }

    for (i = 0; i < sizeof(pinRow) / sizeof(pinRow[0]); i++)
        rt_pin_write(pinRow[i], PIN_LOW);
//    if(ret)
//    rt_kprintf("\tKeyVal:\t%5" PRId32 "\r",ret);
    return ret;
}

void update_game_button(void)
{
    int32_t keys = 0;
    keys = key_read();
    for (int i = 0; i < 16; ++i)
    {
        if ((keys & (1 << i)) != 0)
        {
            key[i] = 1;
        }
        else
        {
            key[i] = 0;
        }
    }
//    if (keys>0) {
//        rt_kprintf("\n");
//        for (int i = 0; i < 16; ++i) {
//            rt_kprintf("  key[0x%X]=%d\t",i,key[i]);
//        }
//        rt_kprintf("\r");
//    }
}

#define THREAD_PRIORITY         25
#define THREAD_STACK_SIZE       512
#define THREAD_TIMESLICE        1

static rt_thread_t tid1 = RT_NULL;
static rt_thread_t tid2 = RT_NULL;

/* Entry Function for Thread 1 */
static void thread1_entry(void *parameter)
{
//    rt_uint32_t count = 0;

    while (1)
    {
        /* Thread 1 runs with low priority and prints the count value all the time */
//        rt_kprintf("thread1 count: %d\n", count ++);
//        rt_thread_mdelay(500);
        rt_pin_write(LED0_PIN, PIN_HIGH);
//        rt_pin_write(SPEAKER_PIN, PIN_HIGH);
        rt_thread_mdelay(500);
        rt_pin_write(LED0_PIN, PIN_LOW);
//        rt_pin_write(SPEAKER_PIN, PIN_LOW);
        rt_thread_mdelay(500);
    }
}

/* Entry Function for Thread 2 */
static void thread2_entry(void *parameter)
{

//    uint8_t x,y;
    while (1)
    {

        emulateCycle();
//        rt_thread_mdelay(5);
        if (beep)
        {
            rt_pin_write(SPEAKER_PIN, PIN_HIGH);
            rt_thread_mdelay(100);
            rt_pin_write(SPEAKER_PIN, PIN_LOW);
        }
        else
        {
            rt_pin_write(SPEAKER_PIN, PIN_LOW);
        }
        if (drawFlag)
        {
            //lcd_clr();

            if (pixdbl)
            {
                for (y = 0; y < 32; y++) // y 16+1 shift to center screen with borders
                {
                    for (x = 0; x < 64; x++) // x 32+1 shift to center screen with borders
                    {
                        if (gfx[((y) * 64) + (x)] == 0)
                            putpixel(x, y, PIXEL_OFF);
                        else
                            putpixel(x, y, PIXEL_ON);
                    }
                }
            }
            else
            {
                for (y = 16; y < 49; y++) // y 16+1 shift to center screen with borders
                {
                    for (x = 32; x < 97; x++) // x 32+1 shift to center screen with borders
                    {
                        if (gfx[((y - 16) * 64) + (x - 32)] == 0)
                            putpixel(x, y, PIXEL_OFF);

                        else
                            putpixel(x, y, PIXEL_ON);
                    }
                }
            }

            drawFlag = false;
            ssd1306_UpdateScreen();

        }
        update_game_button();

//        if(quit)
//        {
//            press=1;
//            quit = 0;
//            current=1;
//            select_b=0;
//            break;
//        }

    }
}

int main(void)
{
    /* set LED0 pin mode to output */
    rt_pin_mode(LED0_PIN, PIN_MODE_OUTPUT);

    /* set SPEAKER pin mode to output */
    rt_pin_mode(SPEAKER_PIN, PIN_MODE_OUTPUT);
    rt_pin_write(SPEAKER_PIN, PIN_LOW);

    key_init();

    draw_Intro();
    rt_thread_mdelay(3000);
    rt_pin_write(SPEAKER_PIN, PIN_HIGH);
    rt_thread_mdelay(500);
    rt_pin_write(SPEAKER_PIN, PIN_LOW);
    if (key_read()>0) {
        pixdbl = 1;
    } else {
        pixdbl = 0;
    }


    ssd1306_Fill(Black);
    if (!pixdbl)
    {
        ssd1306_SetCursor(2, 0);
        ssd1306_WriteString(" ROM Name: Tetris", Font_6x8, White);
        ssd1306_DrawRectangle(31, 15, 97, 49, White);
    }
    ssd1306_UpdateScreen();
    init8();
//    loadApplication(test_opcode, sizeof(test_opcode));
//    loadApplication(Space_Invaders, sizeof(Space_Invaders));
    loadApplication(Tetris_Fran_Dachille_1991_, sizeof(Tetris_Fran_Dachille_1991_));

    /* Create thread 1, Name is thread1，Entry is thread1_entry */
    tid1 = rt_thread_create("thread1", thread1_entry, RT_NULL,
    THREAD_STACK_SIZE,
    THREAD_PRIORITY, THREAD_TIMESLICE);

    /* Start this thread if you get the thread control block */
    if (tid1 != RT_NULL)
        rt_thread_startup(tid1);

    /* Create thread 2, Name is thread2，Entry is thread2_entry */
    tid2 = rt_thread_create("thread2", thread2_entry, RT_NULL,
    THREAD_STACK_SIZE,
    THREAD_PRIORITY, THREAD_TIMESLICE);

    /* Start this thread if you get the thread control block */
    if (tid2 != RT_NULL)
        rt_thread_startup(tid2);

    return RT_EOK;
}
